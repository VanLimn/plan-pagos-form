<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Acuerdo de Financiamiento</title>

  <!-- ✅ Link preview (Open Graph / WhatsApp / Facebook) -->
  <meta property="og:title" content="Acuerdo de Financiamiento" />
  <meta property="og:description" content="Captura tus abonos y programa los pagos que mejor te queden." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://vanlimn.github.io/plan-pagos-form/" />
  <meta property="og:image" content="https://vanlimn.github.io/plan-pagos-form/og-image.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />

  <!-- ✅ Twitter card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Acuerdo de Financiamiento" />
  <meta name="twitter:description" content="Captura tus abonos y programa los pagos que mejor te queden." />
  <meta name="twitter:image" content="https://vanlimn.github.io/plan-pagos-form/og-image.png" />

  <!-- ✅ Favicon -->
  <link rel="icon" href="og-image.png" type="image/png" />

  <style>
    :root{
      --bg:#0b0c10;
      --card:#11131a;
      --text:#e9ecf1;
      --muted:#aab2c0;
      --line:#202433;
      --accent:#7c5cff;
      --danger:#ff4d6d;
      --ok:#37d67a;
      --warn:#ffcc00;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 700px at 20% -10%, rgba(124,92,255,.35), transparent 55%),
                  radial-gradient(900px 600px at 90% 0%, rgba(55,214,122,.18), transparent 50%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .wrap{ width:min(920px, 100%); display:grid; grid-template-columns: 1fr; gap:14px; }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: 18px;
      overflow:hidden;
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
    }
    .header{
      padding:18px 18px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .title{ display:flex; flex-direction:column; gap:6px; }
    .title h1{ margin:0; font-size:18px; letter-spacing:.2px; font-weight:650; }
    .title p{ margin:0; color:var(--muted); font-size:13px; line-height:1.35; }
    .progress{ display:flex; align-items:center; gap:10px; min-width:220px; justify-content:flex-end; flex:1; }
    .bar{
      width:160px; height:8px;
      background:#0f1118;
      border:1px solid var(--line);
      border-radius:999px;
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent), rgba(124,92,255,.55));
      transition: width .25s ease;
    }
    .stepLabel{ color:var(--muted); font-size:12px; white-space:nowrap; }

    .content{ padding:18px; }
    .step{ display:none; animation: fade .18s ease; }
    .step.active{display:block}
    @keyframes fade{ from{opacity:.5; transform: translateY(2px)} to{opacity:1; transform: translateY(0)} }

    .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:12px; }
    .field{ grid-column: span 12; display:flex; flex-direction:column; gap:8px; }
    @media (min-width:720px){
      .field.half{grid-column: span 6;}
      .field.third{grid-column: span 4;}
      .field.twoThird{grid-column: span 8;}
    }

    label{ font-size:13px; color:#d7dbe5; }
    input, select{
      background:#0f1118;
      color:var(--text);
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px 12px;
      outline:none;
      font-size:14px;
    }
    input::placeholder{color:#7f889a}
    input:focus, select:focus{
      border-color: rgba(124,92,255,.7);
      box-shadow: 0 0 0 3px rgba(124,92,255,.12);
    }

    .badField{
      border-color: rgba(255,77,109,.85) !important;
      box-shadow: 0 0 0 3px rgba(255,77,109,.10) !important;
    }

    .hint{ margin-top:-2px; color:var(--muted); font-size:12px; line-height:1.35; }
    .error{ color:var(--danger); font-size:12px; display:none; }
    .error.show{display:block}

    .footer{
      padding:14px 18px;
      border-top:1px solid var(--line);
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
    }
    .btns{ display:flex; gap:10px; flex-wrap:wrap; }
    button{
      border:1px solid var(--line);
      background:#0f1118;
      color:var(--text);
      border-radius:999px;
      padding:10px 14px;
      font-size:13px;
      cursor:pointer;
      transition: transform .06s ease, border-color .2s ease, background .2s ease, opacity .2s ease;
      font-weight:600;
    }
    button:hover{ border-color: rgba(124,92,255,.6); background: rgba(124,92,255,.08); }
    button:active{transform: translateY(1px)}
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .primary{
      border-color: rgba(124,92,255,.65);
      background: linear-gradient(90deg, rgba(124,92,255,.28), rgba(124,92,255,.12));
      font-weight:700;
    }

    /* ✅ BOTÓN NEGRO (más visible) */
    .primaryBlack{
      background:#0b0c10 !important;
      border-color:#0b0c10 !important;
      color:#ffffff !important;
      font-weight:800 !important;
    }
    .primaryBlack:hover{
      background:#12141a !important;
      border-color:#12141a !important;
    }

    .small{ padding:8px 12px; font-size:12px; }

    .payments{ display:flex; flex-direction:column; gap:10px; margin-top:6px; }
    .payRow{
      display:grid;
      grid-template-columns: 1fr 1fr auto;
      gap:10px;
      align-items:end;
      padding:12px;
      border:1px solid var(--line);
      border-radius:14px;
      background: rgba(255,255,255,.02);
    }
    @media (max-width:520px){ .payRow{grid-template-columns: 1fr;} }

    .rowError{
      grid-column: 1 / -1;
      display:none;
      color: var(--danger);
      font-size:12px;
      line-height:1.35;
      margin-top:2px;
    }
    .rowError.show{ display:block; }

    .tag{ display:inline-flex; align-items:center; gap:8px; color:var(--muted); font-size:12px; }
    .tagDot{
      width:8px;height:8px;border-radius:999px;background: var(--accent);
      box-shadow: 0 0 0 3px rgba(124,92,255,.12);
    }

    .summaryBox{
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      background: rgba(255,255,255,.02);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .summaryGrid{ display:grid; grid-template-columns: 1fr; gap:10px; }
    @media (min-width:720px){ .summaryGrid{grid-template-columns: 1fr 1fr;} }
    .kv{
      border:1px solid var(--line);
      background:#0f1118;
      border-radius:12px;
      padding:12px;
    }
    .kv .k{color:var(--muted); font-size:12px; margin-bottom:6px;}
    .kv .v{font-size:14px; word-break:break-word;}

    .toast{
      position:fixed;
      bottom:18px;
      left:50%;
      transform:translateX(-50%);
      background:#0f1118;
      border:1px solid var(--line);
      border-radius:999px;
      padding:10px 14px;
      color:var(--text);
      font-size:12px;
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-2px); }

    .success{
      border:1px solid rgba(55,214,122,.35);
      background: rgba(55,214,122,.06);
      border-radius:14px;
      padding:14px;
      color:#dff7ea;
    }
    .sending{
      border:1px solid rgba(124,92,255,.35);
      background: rgba(124,92,255,.06);
      border-radius:14px;
      padding:14px;
      color:#e9ecff;
    }
    .warning{
      border:1px solid rgba(255,204,0,.35);
      background: rgba(255,204,0,.06);
      border-radius:14px;
      padding:14px;
      color:#fff3c4;
    }
    .hidden{ display:none !important; }

    /* =========================
       ✅ ACUERDO (alineado)
       ========================= */
    .agreementWrap{
      background:#ffffff;
      color:#0b0c10;
      border-radius:18px;
      padding:28px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
    }

    /* ✅ Header alineado (título con logo) */
    .agreementHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:18px;
      margin-bottom:18px;
    }
    .agreementLeft{
      max-width: 62%;
    }
    .agreementTitle{
      margin:0;
      font-size:52px;
      line-height:0.98;
      font-weight:900;
      letter-spacing:-0.5px;
    }
    .agreementSub{
      margin:12px 0 0;
      font-size:34px;
      line-height:1.05;
      font-weight:700;
      letter-spacing:-0.2px;
    }
    .agreementSub span{
      font-weight:500;
    }
    .brandLogo{
      width:220px;
      height:auto;
      object-fit:contain;
      margin-top:6px; /* micro ajuste para alinear visualmente */
    }

    @media (max-width:720px){
      .agreementHeader{ flex-direction:column; align-items:flex-start; }
      .agreementLeft{ max-width:100%; }
      .brandLogo{ width:200px; margin-top:0; }
      .agreementTitle{ font-size:42px; }
      .agreementSub{ font-size:28px; }
    }

    .agreementSectionTitle{
      margin:22px 0 10px;
      font-size:20px;
      font-weight:800;
    }

    .checkList{
      display:flex;
      flex-direction:column;
      gap:14px;
      margin-top:10px;
    }
    .checkItem{
      display:grid;
      grid-template-columns: 30px 1fr;
      gap:12px;
      align-items:flex-start;
      font-size:18px;
      line-height:1.35;
    }
    .box{
      width:26px;height:26px;
      border:3px solid #0b0c10;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      border-radius:3px;
      margin-top:2px;
    }
    .box::after{
      content:"✓";
      font-size:20px;
      line-height:1;
    }
    .planBlock{
      margin:16px 0 6px;
      font-size:18px;
      line-height:1.45;
    }
    .planBlock b{ font-weight:900; }
    .bullets{
      margin:10px 0 0 18px;
      padding:0;
      font-size:20px;
      line-height:1.6;
    }
    .bullets li{ margin:4px 0; }

    .signTitle{
      margin:26px 0 10px;
      font-size:28px;
      font-weight:900;
      line-height:1.15;
    }
    .signTip{
      margin:0;
      font-size:18px;
      color:#2c2f37;
    }
    .signWarn{
      margin-top:10px;
      font-size:18px;
      color:#b00020;
      font-weight:700;
      white-space:pre-wrap;
    }
    .signRow{
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .signInput{
      width:100%;
      padding:16px 16px;
      border-radius:16px;
      border:2px solid rgba(124,92,255,.45);
      outline:none;
      font-size:22px;
    }
    .signInput:focus{
      border-color: rgba(124,92,255,.9);
      box-shadow: 0 0 0 6px rgba(124,92,255,.12);
    }
    .signInput.badField{
      border-color: rgba(255,77,109,.9) !important;
      box-shadow: 0 0 0 6px rgba(255,77,109,.12) !important;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="title">
          <h1>Formulario · Plan de Pagos</h1>
          <p>Captura de datos + calendarización de pagos. Multi-paso con Back/Next.</p>
        </div>
        <div class="progress">
          <div class="stepLabel" id="stepLabel">Paso 1 de 6</div>
          <div class="bar" aria-hidden="true"><div id="barFill"></div></div>
        </div>
      </div>

      <div class="content">
        <!-- STEP 1 -->
        <section class="step active" data-step="1">
          <div class="grid">
            <div class="field half">
              <label for="nombres">Nombres</label>
              <input id="nombres" type="text" placeholder="Ej. Iliana Vanessa" autocomplete="given-name" />
              <div class="error" id="err_nombres">Escribe tus nombres.</div>
            </div>

            <div class="field half">
              <label for="apellidos">Apellidos</label>
              <input id="apellidos" type="text" placeholder="Ej. Enciso Bolaños" autocomplete="family-name" />
              <div class="error" id="err_apellidos">Escribe tus apellidos.</div>
            </div>

            <div class="field">
              <div class="tag"><span class="tagDot"></span><span>Esto va por páginas (Back / Next).</span></div>
            </div>
          </div>
        </section>

        <!-- STEP 2 -->
        <section class="step" data-step="2">
          <div class="grid">
            <div class="field twoThird">
              <label for="email">Correo electrónico</label>
              <input id="email" type="email" placeholder="tucorreo@dominio.com" autocomplete="email" />
              <div class="hint">Se usará para confirmaciones o seguimiento.</div>
              <div class="error" id="err_email">Escribe un correo válido.</div>
            </div>

            <div class="field third">
              <label for="lada">Lada (país)</label>
              <select id="lada" autocomplete="tel-country-code">
                <option value="+52" selected>+52 (MX)</option>
                <option value="+1">+1 (US/CA)</option>
                <option value="+34">+34 (ES)</option>
                <option value="+57">+57 (CO)</option>
                <option value="+54">+54 (AR)</option>
                <option value="+56">+56 (CL)</option>
                <option value="+51">+51 (PE)</option>
              </select>
              <div class="hint">Puedes ampliar esta lista.</div>
            </div>

            <div class="field">
              <label for="telefono">Número de teléfono</label>
              <input id="telefono" type="tel" placeholder="Ej. 3312345678" autocomplete="tel-national" inputmode="numeric" />
              <div class="hint">Solo números (sin espacios). Debe ser exactamente 10 dígitos.</div>
              <div class="error" id="err_telefono">Escribe un teléfono válido (10 dígitos).</div>
            </div>
          </div>
        </section>

        <!-- STEP 3 -->
        <section class="step" data-step="3">
          <div class="grid">
            <div class="field">
              <label for="abonoInicial">¿De cuánto fue tu abono inicial?</label>
              <input id="abonoInicial" inputmode="decimal" placeholder="Ej. 10,000" />
              <div class="hint">Número (sin $). Se formatea automático.</div>
              <div class="error" id="err_abonoInicial">Escribe un monto válido (&gt;= 0).</div>
            </div>
          </div>
        </section>

        <!-- STEP 4 -->
        <section class="step" data-step="4">
          <div class="grid">
            <div class="field">
              <label for="numPagos">¿Cuántos pagos vas a querer que sean?</label>
              <input id="numPagos" type="number" min="1" max="50" step="1" placeholder="Ej. 3" inputmode="numeric" />
              <div class="hint">Al poner un número, se generan los campos de fecha + monto.</div>
              <div class="error" id="err_numPagos">Indica un número de pagos (1–50).</div>
            </div>

            <div class="field">
              <div class="tag"><span class="tagDot"></span><span>Vamos a empezar con tu plan de pagos.</span></div>
            </div>

            <div class="field">
              <div id="paymentsContainer" class="payments"></div>

              <div class="error" id="err_payments">
                <div style="font-weight:600; margin-bottom:6px;">Revisa estos pagos:</div>
                <div id="err_payments_list" style="white-space:pre-wrap; line-height:1.4;"></div>
              </div>

              <div class="summaryBox" id="liveTotalsBox" style="margin-top:12px;">
                <div class="tag"><span class="tagDot"></span><span>Totales en vivo</span></div>

                <div class="kv" style="grid-column: 1 / -1;">
                  <div class="k">Tu abono hasta el momento es de</div>
                  <div class="v" id="liveTotalPaid">$0.00</div>
                </div>

                <div class="summaryGrid">
                  <div class="kv">
                    <div class="k">Ticket</div>
                    <div class="v" id="liveTicketTotal">$50,000.00</div>
                  </div>
                  <div class="kv">
                    <div class="k">Restante pendiente</div>
                    <div class="v" id="liveRemaining">$50,000.00</div>
                  </div>
                </div>

                <div class="warning hidden" id="liveWarn"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- STEP 5: RESUMEN -->
        <section class="step" data-step="5">
          <div class="summaryBox">
            <div class="tag">
              <span class="tagDot"></span>
              <span>Resumen final (listo) | Por favor, revisa que todos tus datos estén correctos. Número de teléfono principalmente.</span>
            </div>

            <div class="summaryGrid" id="summaryGrid"></div>

            <div class="warning hidden" id="validationBox"></div>

            <div class="hint">Siguiente: leer el acuerdo, firmar tu nombre y enviar.</div>
          </div>
        </section>

        <!-- STEP 6: ACUERDO + FIRMA + ENVIAR -->
        <section class="step" data-step="6">
          <div class="agreementWrap">
            <div class="agreementHeader">
              <div class="agreementLeft">
                <h2 class="agreementTitle">ACUERDO DE<br/>FINANCIAMIENTO</h2>
                <div class="agreementSub">&gt; <b>circle x ab</b> <span>| Febrero 2026</span></div>
              </div>

              <!-- ✅ Logo correcto -->
              <img class="brandLogo" src="xab-university.png" alt="x ab university" />
            </div>

            <div class="agreementSectionTitle">Estoy de acuerdo con que la empresa</div>
            <div class="checkList">
              <div class="checkItem"><div class="box"></div><div>use mi <b>imagen</b> en fotos y videos promocionales en el futuro;</div></div>
              <div class="checkItem"><div class="box"></div><div>no es responsable de <b>robo/extravío</b> de mis pertenencias;</div></div>
              <div class="checkItem"><div class="box"></div><div>me expulse de las instalaciones si mi <b>conducta</b> altera negativamente el evento.</div></div>
              <div class="checkItem"><div class="box"></div><div>daré los créditos debidos al compartir públicamente <b>contenido</b> del evento.</div></div>
            </div>

            <div class="agreementSectionTitle">Estoy de acuerdo también con que</div>
            <div class="checkList">
              <div class="checkItem"><div class="box"></div><div>no hay <b>reembolsos/cancelaciones/devoluciones</b> del apartado y/o pagos realizados.</div></div>
              <div class="checkItem"><div class="box"></div><div>la fecha límite para <b>cambios de workshop</b> es un mes antes del evento.</div></div>
              <div class="checkItem"><div class="box"></div><div>mantendré las <b>fechas de pago acordadas</b> para conservar el precio especial; de no hacerlo, el monto total se ajustará al precio público.</div></div>
            </div>

            <!-- ✅ MI PLAN DE PAGO -->
            <div class="planBlock" id="agreementPlanBlock">
              <b>Mi plan de pago:</b>
              <ul class="bullets" id="agreementPlanList"></ul>
            </div>

            <div class="agreementSectionTitle">Estoy de acuerdo con que para ingresar a las instalaciones</div>
            <div class="checkList">
              <div class="checkItem"><div class="box"></div><div>presento en recepción mi identificación oficial vigente con fotografía.</div></div>
              <div class="checkItem"><div class="box"></div><div>muestro en recepción foto y texto de presentación que compartí en el WhatsApp del evento.</div></div>
              <div class="checkItem"><div class="box"></div><div>debo tener firmado este MOU.</div></div>
              <div class="checkItem"><div class="box"></div><div>estoy de acuerdo con escuchar y leer toda la información e indicaciones del workshop que se envíen por WhatsApp.</div></div>
            </div>

            <!-- ✅ FIRMA -->
            <div class="signTitle">Pon aquí tu nombre completo, idéntico a tu INE para confirmar de enterado el acuerdo de financiamiento.</div>

            <div class="signRow">
              <input id="signatureName" class="signInput" type="text" placeholder="Escribe tu nombre completo" />
              <p class="signTip">Tip: Debe coincidir con el nombre que capturaste en el formulario (para evitar errores).</p>
              <div id="signatureWarn" class="signWarn hidden"></div>
            </div>

            <div style="margin-top:18px; display:flex; gap:12px; flex-wrap:wrap;">
              <button class="small primaryBlack" id="sendBtn" type="button">Enviar</button>
            </div>

            <div class="sending hidden" id="sendingBox" style="margin-top:14px;">Enviando…</div>
            <div class="success hidden" id="successBox" style="margin-top:14px;">Listo ✅ Se registró tu plan de pagos.</div>
            <div class="error" id="failBox" style="display:none; margin-top:12px;">No se pudo enviar. Revisa tu conexión e intenta otra vez.</div>

            <iframe name="hiddenFrame" class="hidden" id="hiddenFrame"></iframe>
            <form id="postForm" class="hidden" method="POST" target="hiddenFrame">
              <input type="hidden" name="payload" id="payloadField" />
            </form>
          </div>
        </section>

      </div>

      <div class="footer">
        <div class="hint" id="footerHint">Tip: Enter también avanza cuando es válido.</div>
        <div class="btns">
          <button id="backBtn" type="button">Back</button>
          <button id="nextBtn" class="primary" type="button">Next</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Enviado ✅</div>

  <script>
    // ✅ URL del Apps Script Web App
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzPnXt2ybkixu9FgPa2S9AAx_ac5DZi-uJ_dUz14BIAczRgK0_my25m7NrgY5-DhdqoZQ/exec";

    // Reglas de negocio
    const TICKET_TOTAL = 50000;
    const MAX_DATE = "2026-11-30"; // última fecha permitida

    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    const MIN_DATE = todayISO();
    const REMAINING_TOL = 0.01;

    const steps = Array.from(document.querySelectorAll(".step"));
    let currentStep = 1;

    const stepLabel = document.getElementById("stepLabel");
    const barFill = document.getElementById("barFill");
    const backBtn = document.getElementById("backBtn");
    const nextBtn = document.getElementById("nextBtn");
    const footerHint = document.getElementById("footerHint");

    const nombres = document.getElementById("nombres");
    const apellidos = document.getElementById("apellidos");
    const email = document.getElementById("email");
    const lada = document.getElementById("lada");
    const telefono = document.getElementById("telefono");

    const abonoInicial = document.getElementById("abonoInicial");

    const numPagos = document.getElementById("numPagos");
    const paymentsContainer = document.getElementById("paymentsContainer");

    const err_nombres = document.getElementById("err_nombres");
    const err_apellidos = document.getElementById("err_apellidos");
    const err_email = document.getElementById("err_email");
    const err_telefono = document.getElementById("err_telefono");
    const err_abonoInicial = document.getElementById("err_abonoInicial");
    const err_numPagos = document.getElementById("err_numPagos");
    const err_payments = document.getElementById("err_payments");
    const err_payments_list = document.getElementById("err_payments_list");

    const summaryGrid = document.getElementById("summaryGrid");
    const validationBox = document.getElementById("validationBox");

    // ✅ live totals
    const liveTotalPaidEl = document.getElementById("liveTotalPaid");
    const liveTicketTotalEl = document.getElementById("liveTicketTotal");
    const liveRemainingEl = document.getElementById("liveRemaining");
    const liveWarn = document.getElementById("liveWarn");

    // ✅ Step 6
    const agreementPlanList = document.getElementById("agreementPlanList");
    const signatureName = document.getElementById("signatureName");
    const signatureWarn = document.getElementById("signatureWarn");

    const sendBtn = document.getElementById("sendBtn");
    const successBox = document.getElementById("successBox");
    const sendingBox = document.getElementById("sendingBox");
    const failBox = document.getElementById("failBox");

    const toast = document.getElementById("toast");

    const postForm = document.getElementById("postForm");
    const payloadField = document.getElementById("payloadField");
    const hiddenFrame = document.getElementById("hiddenFrame");

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"), 1100);
    }

    function setStep(n){
      currentStep = n;
      steps.forEach(s => s.classList.toggle("active", Number(s.dataset.step) === currentStep));

      const total = steps.length;
      stepLabel.textContent = `Paso ${currentStep} de ${total}`;
      barFill.style.width = `${Math.round((currentStep-1)/(total-1)*100)}%`;

      backBtn.disabled = currentStep === 1;

      if(currentStep === total){
        nextBtn.style.display = "none";
        footerHint.textContent = "Lee el acuerdo, firma tu nombre y presiona Enviar.";
      } else {
        nextBtn.style.display = "inline-flex";
        footerHint.textContent = "Tip: Enter también avanza cuando es válido.";
      }

      const focusMap = {1:nombres, 2:email, 3:abonoInicial, 4:numPagos, 6:signatureName};
      if(focusMap[currentStep]) focusMap[currentStep].focus();

      if(currentStep === 4) updateLiveTotals();
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    function show(el, yes){ el.classList.toggle("show", !!yes); }
    function hide(el){ el.classList.add("hidden"); }
    function unhide(el){ el.classList.remove("hidden"); }

    function parseAmount(str){
      const cleaned = (str || "").toString().replace(/,/g,'').trim();
      if(cleaned === "") return NaN;
      const n = Number(cleaned);
      return Number.isFinite(n) ? n : NaN;
    }

    function isValidISODate(dateStr){
      if(!dateStr || typeof dateStr !== "string") return false;
      const m = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(!m) return false;

      const y = Number(m[1]);
      const mo = Number(m[2]);
      const d = Number(m[3]);
      if(!Number.isInteger(y) || !Number.isInteger(mo) || !Number.isInteger(d)) return false;
      if(mo < 1 || mo > 12) return false;
      if(d < 1 || d > 31) return false;

      const dt = new Date(Date.UTC(y, mo - 1, d));
      return dt.getUTCFullYear() === y && (dt.getUTCMonth()+1) === mo && dt.getUTCDate() === d;
    }

    function validateStep1(){
      const okN = nombres.value.trim().length > 0;
      const okA = apellidos.value.trim().length > 0;
      show(err_nombres, !okN);
      show(err_apellidos, !okA);
      return okN && okA;
    }

    function validateStep2(){
      const okE = emailRegex.test(email.value.trim());
      const digits = telefono.value.replace(/\D/g,'');
      const okT = digits.length === 10; // ✅ EXACTAMENTE 10
      show(err_email, !okE);
      show(err_telefono, !okT);
      return okE && okT;
    }

    function validateStep3(){
      const val = abonoInicial.value.trim();
      const n = val === "" ? 0 : parseAmount(val);
      const ok = Number.isFinite(n) && n >= 0;
      show(err_abonoInicial, !ok);
      return ok;
    }

    function clearRowValidation(row){
      const d = row.querySelector("input[type='date']");
      const a = row.querySelector("input[data-role='amount']");
      const re = row.querySelector(".rowError");

      d.classList.remove("badField");
      a.classList.remove("badField");
      re.classList.remove("show");
      re.textContent = "";
    }

    function appendRowError(row, text){
      const rowErr = row.querySelector(".rowError");
      const current = (rowErr.textContent || "").trim();
      if(current){
        if(!current.split("\n").includes(text)){
          rowErr.textContent = current + "\n" + text;
        }
      } else {
        rowErr.textContent = text;
      }
      rowErr.classList.add("show");
    }

    function validatePaymentRow(row, idx){
      const dateInput = row.querySelector("input[type='date']");
      const amtInput  = row.querySelector("input[data-role='amount']");
      const rowErr    = row.querySelector(".rowError");

      clearRowValidation(row);

      const errors = [];

      const dateVal = dateInput.value;
      if(!dateVal){
        errors.push(`Pago ${idx}: Falta la fecha.`);
        dateInput.classList.add("badField");
      } else if(!isValidISODate(dateVal)){
        errors.push(`Pago ${idx}: Fecha inválida (${dateVal}).`);
        dateInput.classList.add("badField");
      } else if(!(dateVal >= MIN_DATE && dateVal <= MAX_DATE)){
        errors.push(`Pago ${idx}: Fecha fuera de rango (${dateVal}). Debe ser ${MIN_DATE} a ${MAX_DATE}.`);
        dateInput.classList.add("badField");
      }

      const amount = Number((amtInput.value || "").replace(/,/g,''));
      if(!(amount > 0)){
        errors.push(`Pago ${idx}: Monto inválido. Debe ser mayor a 0.`);
        amtInput.classList.add("badField");
      }

      if(errors.length){
        rowErr.textContent = errors.join("\n");
        rowErr.classList.add("show");
      }

      return errors;
    }

    // ✅ valida pagos: individuales + fechas únicas + ORDEN cronológico (no puede bajar)
    function validatePaymentsDetailed(){
      const n = Number(numPagos.value);
      const rows = Array.from(paymentsContainer.querySelectorAll(".payRow"));

      err_payments_list.textContent = "";
      show(err_payments, false);
      rows.forEach(r => clearRowValidation(r));

      if(rows.length !== n) {
        return { ok:false, errors:[`Cantidad de filas (${rows.length}) no coincide con número de pagos (${n}).`] };
      }

      const allErrors = [];

      // 1) validaciones individuales
      for(let i=0;i<rows.length;i++){
        const rowErrors = validatePaymentRow(rows[i], i+1);
        allErrors.push(...rowErrors);
      }

      // 2) fechas NO repetidas
      const dateMap = new Map();
      for(let i=0;i<rows.length;i++){
        const dateInput = rows[i].querySelector("input[type='date']");
        const dateVal = (dateInput.value || "").trim();
        if(dateVal && isValidISODate(dateVal)){
          if(!dateMap.has(dateVal)) dateMap.set(dateVal, []);
          dateMap.get(dateVal).push(i);
        }
      }
      for(const [dateVal, idxs] of dateMap.entries()){
        if(idxs.length > 1){
          const pagosHuman = idxs.map(i => i+1).join(", ");
          allErrors.push(`Fechas repetidas: La fecha ${dateVal} está repetida en los pagos: ${pagosHuman}. Deben ser todas diferentes.`);
          for(const i of idxs){
            const row = rows[i];
            const dateInput = row.querySelector("input[type='date']");
            dateInput.classList.add("badField");
            appendRowError(row, `Fecha repetida: ${dateVal}. Este pago no puede compartir fecha con otro.`);
          }
        }
      }

      // 3) ✅ ORDEN CRONOLÓGICO (cada pago >= anterior)
      let prev = null;
      for(let i=0;i<rows.length;i++){
        const dateInput = rows[i].querySelector("input[type='date']");
        const dateVal = (dateInput.value || "").trim();
        if(dateVal && isValidISODate(dateVal)){
          if(prev && dateVal < prev){
            allErrors.push(`Orden inválido: Pago ${i+1} (${dateVal}) no puede ser antes que el pago anterior (${prev}).`);
            dateInput.classList.add("badField");
            appendRowError(rows[i], `Orden inválido: esta fecha no puede ser antes que la del pago anterior (${prev}).`);
          } else {
            prev = dateVal;
          }
        }
      }

      const ok = allErrors.length === 0;
      if(!ok){
        err_payments_list.textContent = allErrors.join("\n");
        show(err_payments, true);
      }
      return { ok, errors: allErrors };
    }

    function validateStep4(){
      const n = Number(numPagos.value);
      const okN = Number.isInteger(n) && n >= 1 && n <= 50;
      show(err_numPagos, !okN);
      if(!okN) return false;

      const result = validatePaymentsDetailed();
      return result.ok;
    }

    function formatCurrencyInput(value){
      const cleaned = (value || "").toString().replace(/[^\d.]/g,'');
      if(cleaned === "") return "";
      const parts = cleaned.split(".");
      const intPart = parts[0].replace(/^0+(?=\d)/, "");
      const formatted = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      return parts.length > 1 ? `${formatted}.${parts[1].slice(0,2)}` : formatted;
    }

    function money(n){
      const x = Number(n || 0);
      return x.toLocaleString("es-MX", { style:"currency", currency:"MXN" });
    }

    function remainingIsZero(restante){
      return Math.abs(Number(restante || 0)) <= REMAINING_TOL;
    }

    abonoInicial.addEventListener("input", ()=>{
      const caret = abonoInicial.selectionStart;
      const before = abonoInicial.value;
      abonoInicial.value = formatCurrencyInput(abonoInicial.value);
      const delta = abonoInicial.value.length - before.length;
      try { abonoInicial.setSelectionRange(caret + delta, caret + delta); } catch(e){}
      show(err_abonoInicial, false);
      updateLiveTotals();
    });

    function buildPaymentRows(count){
      paymentsContainer.innerHTML = "";
      for(let i=1;i<=count;i++){
        const row = document.createElement("div");
        row.className = "payRow";
        row.innerHTML = `
          <div class="field" style="margin:0;">
            <label>Fecha a abonar · Pago ${i}</label>
            <input type="date" />
            <div class="hint">Rango permitido: ${MIN_DATE} a ${MAX_DATE}</div>
          </div>
          <div class="field" style="margin:0;">
            <label>Monto a abonar</label>
            <input data-role="amount" inputmode="decimal" placeholder="Ej. 2,000" />
            <div class="hint">Número (sin $). Se formatea automático.</div>
          </div>
          <button type="button" class="small" title="Limpiar este pago">Limpiar</button>
          <div class="rowError"></div>
        `;

        const dateInput = row.querySelector("input[type='date']");
        const amt = row.querySelector("input[data-role='amount']");
        const btn = row.querySelector("button");
        const rowErr = row.querySelector(".rowError");

        dateInput.addEventListener("input", ()=>{
          dateInput.classList.remove("badField");
          rowErr.classList.remove("show");
          show(err_payments, false);
          updateLiveTotals();
        });
        dateInput.addEventListener("change", ()=>{
          dateInput.classList.remove("badField");
          rowErr.classList.remove("show");
          show(err_payments, false);
          updateLiveTotals();
        });

        amt.addEventListener("input", () => {
          const caret = amt.selectionStart;
          const before = amt.value;
          amt.value = formatCurrencyInput(amt.value);
          const delta = amt.value.length - before.length;
          try { amt.setSelectionRange(caret + delta, caret + delta); } catch(e){}
          amt.classList.remove("badField");
          rowErr.classList.remove("show");
          show(err_payments, false);
          updateLiveTotals();
        });

        btn.addEventListener("click", ()=>{
          dateInput.value = "";
          amt.value = "";
          clearRowValidation(row);
          show(err_payments, false);
          updateLiveTotals();
        });

        paymentsContainer.appendChild(row);
      }
      updateLiveTotals();
    }

    numPagos.addEventListener("input", () => {
      const n = Number(numPagos.value);
      show(err_numPagos, false);
      show(err_payments, false);
      err_payments_list.textContent = "";
      if(Number.isInteger(n) && n >= 1 && n <= 50){
        buildPaymentRows(n);
      } else {
        paymentsContainer.innerHTML = "";
        updateLiveTotals();
      }
    });

    function collectData(){
      const n = Number(numPagos.value);

      const abonoVal = abonoInicial.value.trim();
      const abono = abonoVal === "" ? 0 : (parseAmount(abonoVal) || 0);

      const rows = Array.from(paymentsContainer.querySelectorAll(".payRow"));
      const pagos = rows.map((row, idx) => {
        const fecha = row.querySelector("input[type='date']").value;
        const montoStr = row.querySelector("input[data-role='amount']").value || "";
        const monto = Number(montoStr.replace(/,/g,'')) || 0;
        return { num: idx+1, fecha, monto };
      });

      const totalPlan = pagos.reduce((acc,p)=>acc + (p.monto || 0), 0);
      const totalPagado = abono + totalPlan;
      const restante = TICKET_TOTAL - totalPagado;

      return {
        contacto: {
          nombres: nombres.value.trim(),
          apellidos: apellidos.value.trim(),
          email: email.value.trim(),
          telefono: {
            lada: lada.value,
            numero: telefono.value.replace(/\D/g,'')
          }
        },
        ticket: {
          total: TICKET_TOTAL,
          abono_inicial: abono,
          total_plan_pagos: totalPlan,
          total_pagado: totalPagado,
          restante: restante
        },
        plan_pagos: {
          cantidad_pagos: n,
          pagos,
          total_programado: totalPlan
        },
        reglas: {
          min_fecha: MIN_DATE,
          max_fecha: MAX_DATE
        },
        meta: {
          created_at_iso: new Date().toISOString(),
          source: "formulario_plan_pagos_v7_agreement_step"
        }
      };
    }

    function updateLiveTotals(){
      if(!liveTotalPaidEl || !liveRemainingEl || !liveTicketTotalEl) return;

      const data = collectData();

      liveTicketTotalEl.textContent = money(TICKET_TOTAL);
      liveTotalPaidEl.textContent = money(data.ticket.total_pagado);
      liveRemainingEl.textContent = money(data.ticket.restante);

      const restante = Number(data.ticket.restante || 0);

      if(Math.abs(restante) <= REMAINING_TOL){
        hide(liveWarn);
        liveWarn.textContent = "";
      } else {
        unhide(liveWarn);
        if(restante > 0){
          liveWarn.textContent = `Aún faltan ${money(restante)} para completar ${money(TICKET_TOTAL)}.`;
        } else {
          liveWarn.textContent = `Vas excedida por ${money(Math.abs(restante))}. Revisa montos.`;
        }
      }
    }

    function renderSummary(data){
      summaryGrid.innerHTML = "";
      hide(validationBox);
      validationBox.textContent = "";

      const fullName = `${data.contacto.nombres} ${data.contacto.apellidos}`.trim();
      const phone = `${data.contacto.telefono.lada} ${data.contacto.telefono.numero}`.trim();

      const blocks = [
        { k:"Nombre completo", v: fullName || "-" },
        { k:"Correo", v: data.contacto.email || "-" },
        { k:"Teléfono", v: phone || "-" },
        { k:"Abono inicial", v: money(data.ticket.abono_inicial) },
        { k:"Cantidad de pagos", v: String(data.plan_pagos.cantidad_pagos || 0) },
        { k:"Total plan de pagos", v: money(data.ticket.total_plan_pagos) },
      ];

      for(const b of blocks){
        const el = document.createElement("div");
        el.className = "kv";
        el.innerHTML = `<div class="k">${b.k}</div><div class="v">${b.v}</div>`;
        summaryGrid.appendChild(el);
      }

      const payList = document.createElement("div");
      payList.className = "kv";
      payList.style.gridColumn = "1 / -1";
      const lines = data.plan_pagos.pagos.map(p => `Pago ${p.num}: ${p.fecha || "(sin fecha)"} · ${money(p.monto)}`);
      payList.innerHTML = `<div class="k">Plan de pagos</div><div class="v" style="white-space:pre-wrap; line-height:1.5;">${lines.join("\n")}</div>`;
      summaryGrid.appendChild(payList);

      const totals = document.createElement("div");
      totals.className = "kv";
      totals.style.gridColumn = "1 / -1";
      totals.innerHTML = `
        <div class="k">Totales</div>
        <div class="v" style="white-space:pre-wrap; line-height:1.6;">
El total de tu ticket es 50,000 pesos
Incluyendo tu abono y tu plan de pagos, el total pagado es ${money(data.ticket.total_pagado)}
Restante pendiente: ${money(data.ticket.restante)}
        </div>
      `;
      summaryGrid.appendChild(totals);

      const restante = Number(data.ticket.restante || 0);
      if (!remainingIsZero(restante)) {
        unhide(validationBox);
        validationBox.textContent =
          (restante > 0)
          ? `Hey, hay algo raro aquí: con tu abono + tu plan de pagos aún faltan ${money(restante)} para completar ${money(TICKET_TOTAL)}. Revisa montos/fechas.`
          : `Hey, hay algo raro aquí: tu abono + tu plan de pagos exceden el total del ticket por ${money(Math.abs(restante))}. Revisa montos/fechas.`;
      }
    }

    function normalizeName(s){
      return (s || "")
        .trim()
        .replace(/\s+/g, " ")
        .toLowerCase();
    }

    function renderAgreement(data){
      // Plan de pagos en el acuerdo
      agreementPlanList.innerHTML = "";
      for(const p of data.plan_pagos.pagos){
        const li = document.createElement("li");
        li.textContent = `${p.fecha || "(sin fecha)"} | ${money(p.monto)}`;
        agreementPlanList.appendChild(li);
      }

      // reset firma visual
      signatureName.value = "";
      signatureName.classList.remove("badField");
      hide(signatureWarn);
      signatureWarn.textContent = "";

      // habilita o deshabilita envío (se hace en validateAgreementReady)
      validateAgreementReady();
    }

    function validateAgreementReady(){
      const data = collectData();

      // Requerimos que Step4 sea válido y restante = 0
      const okPayments = validateStep4();
      const okRestante = remainingIsZero(data.ticket.restante);

      // Firma debe coincidir con nombres+apellidos
      const expected = normalizeName(`${data.contacto.nombres} ${data.contacto.apellidos}`);
      const typed = normalizeName(signatureName.value);

      const okSig = typed.length > 0 && typed === expected;

      if(signatureName.value.trim().length === 0){
        signatureName.classList.remove("badField");
        hide(signatureWarn);
        signatureWarn.textContent = "";
      } else if(!okSig){
        signatureName.classList.add("badField");
        unhide(signatureWarn);
        signatureWarn.textContent = `Tu firma debe coincidir con el nombre capturado en el formulario:\n"${(data.contacto.nombres + " " + data.contacto.apellidos).trim()}"`;
      } else {
        signatureName.classList.remove("badField");
        hide(signatureWarn);
        signatureWarn.textContent = "";
      }

      // Si el resumen no cuadra, no se envía
      sendBtn.disabled = !(okPayments && okRestante && okSig);
      return sendBtn.disabled === false;
    }

    function goNext(){
      const totalSteps = steps.length;

      if(currentStep === 1 && !validateStep1()) return;
      if(currentStep === 2 && !validateStep2()) return;
      if(currentStep === 3 && !validateStep3()) return;
      if(currentStep === 4 && !validateStep4()) {
        const firstBad = paymentsContainer.querySelector(".badField");
        if(firstBad) firstBad.scrollIntoView({behavior:"smooth", block:"center"});
        return;
      }

      if(currentStep < totalSteps){
        if(currentStep === 4){
          const data = collectData();
          renderSummary(data);
        }
        if(currentStep === 5){
          const data = collectData();
          renderAgreement(data);
        }
        setStep(currentStep + 1);
      }
    }

    function goBack(){
      if(currentStep > 1) setStep(currentStep - 1);
    }

    nextBtn.addEventListener("click", goNext);
    backBtn.addEventListener("click", goBack);

    document.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){
        const activeStep = steps.find(s => s.classList.contains("active"));
        const stepNum = activeStep ? Number(activeStep.dataset.step) : 1;
        if(stepNum < steps.length){
          e.preventDefault();
          goNext();
        }
      }
    });

    // ✅ Teléfono: solo dígitos y máximo 10
    telefono.addEventListener("input", ()=>{
      const digits = telefono.value.replace(/[^\d]/g,'').slice(0,10);
      telefono.value = digits;
      show(err_telefono, false);
    });

    // ✅ Firma: revalidar en vivo
    signatureName.addEventListener("input", ()=>{
      validateAgreementReady();
    });

    let awaitingAck = false;
    hiddenFrame.addEventListener("load", () => {
      if(!awaitingAck) return;
      awaitingAck = false;
      hide(sendingBox);
      unhide(successBox);
      showToast("Enviado ✅");
      sendBtn.disabled = true;
    });

    sendBtn.addEventListener("click", ()=>{
      // revalida TODO antes de enviar
      if(!validateAgreementReady()){
        const firstBad = paymentsContainer.querySelector(".badField");
        if(firstBad) firstBad.scrollIntoView({behavior:"smooth", block:"center"});
        return;
      }

      const dataCheck = collectData();
      const payload = JSON.stringify(dataCheck);

      postForm.action = WEB_APP_URL;
      payloadField.value = payload;

      failBox.style.display = "none";
      hide(successBox);
      unhide(sendingBox);
      sendBtn.disabled = true;

      awaitingAck = true;

      setTimeout(() => {
        if(awaitingAck){
          awaitingAck = false;
          hide(sendingBox);
          failBox.style.display = "block";
          validateAgreementReady();
        }
      }, 9000);

      postForm.submit();
    });

    // init
    setStep(1);
    updateLiveTotals();
  </script>
</body>
</html>
